<!DOCTYPE html>
<html xmlns:fb="http://www.facebook.com/2008/fbml" xmlns:g="urn:g">
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8" />
  <meta name="keywords" content="">
  <meta name="description" content="Blog about hackings and development | Use Capistrano">
  <title>Use Capistrano | 杨晨昀 Steven Yang</title>
  <link rel="stylesheet" href="/stylesheets/screen.css">
  <!--[if lt IE 9]>
    <script src="/javascripts/html5.js"></script>
  <![endif]-->
</head>

<body>
  <div class="wrap">
    <div id="sidebar" class="side group clear">
      <header>
        <a href="/">Steven Yang</a>
      </header>
      <nav>
        <ul>
          <li><a href="/about/">About</a></li>
          <li><a href="/contact/">Contact</a></li>
        </ul>

<!-- AddThis Button BEGIN -->
<div class="addthis_toolbox addthis_default_style ">
  <div>
    <a class="addthis_button_facebook_like" fb:like:width="46px"></a>
    <a class='addthis_button_google_plusone' g:plusone:size='small' g:plusone:annotation='none'></a>
    <br class="clear">
  </div>
  <div>
    <a class="addthis_button_douban"></a>
    <a class="addthis_button_sinaweibo"></a>
    <a class="addthis_button_twitter"></a>
    <br class="clear">
  </div>
</div>
<!-- AddThis Button END -->


    </div>
    <div class="content">
      <article class="post">
  <header id="post-title">
    <h1>Use Capistrano</h1>
  </header>
  <div id="post-stats">
    <p>Posted on November  8, 2012</p>
  </div>
  <div id="post-content">
    <h2 id="goals">Goals</h2>
<p>### Assumptions</p>

<p>When get called it loads <code>deploy.rb</code> in <code>config</code> directory.
It searches up the file tree to find the <code>Capfile</code>.</p>

<h2 id="building-blocks">Building Blocks</h2>
<p>### Variables
Variables are used to:
1. config the capistrano
2. reduce the duplicates strings</p>

<ul>
  <li><code>set</code> is used to to create and assign a variable or a proc</li>
  <li>cap variable has global scope</li>
  <li>variable could be retrieved through <code>fetch</code> or string </li>
  <li><code>fetch</code> or string interpolation is used to retrieve the variable</li>
  <li><code>exist?</code> is used to check existense of variable</li>
  <li>use <code>unset</code> to destroy a variable</li>
  <li>Cap implements an <code>_cset</code> to undestructive assignment.</li>
  <li>
    <p>use <code>set</code> with a block to use lazy-assignment</p>

    <p>set :username, ‘Capistrano Wizard’
  set(:user) do
     Capistrano::CLI.ui.ask “Give me a ssh user: “
  end</p>
  </li>
</ul>

<h3 id="tasks">Tasks</h3>
<p>Task is the foundation of capistrano. 
- Task could be invoked with <code>cap task_name</code>.
- Task associates a block of commands which will be run for roles .
- A <code>desc</code> could be defined as the description of this tasks.
- Task has a name which could be used to invoke the tasks elsewhere.
- Task with the same name as exist task will overwrite it.</p>

<pre><code>desc "Search Remote Application Server Libraries"
task :search_libs, :roles =&gt; :app do
  run "ls -x1 /usr/lib | grep -i xml"
end
</code></pre>

<h3 id="namespace">Namespace</h3>
<p>Namespace is used to group related tasks. 
- It is called with a block of tasks. 
- Tasks with namespace could be invoked with <code>cap namespace:task_name</code>.
- The default and omitted namespace is <code>top</code>.</p>

<pre><code>namespace :backup do

  task :default do
    web
    db
  end

  task :web, :roles =&gt; :web do
    puts "Backing Up Web Server"
  end

  task :db, :roles =&gt; :db do
    puts "Backing Up DB Server"
  end

end
</code></pre>

<h3 id="chains">Chains</h3>
<ul>
  <li>Task could invoke other tasks by refer its name.</li>
  <li>
    <p>Callback is used to chain task or group of tasks together in sequence.</p>

    <p>namespace :deploy do
    task :default do
      update
      restart           # &lt;= v2.5.5
    end
  end</p>

    <p>after(“deploy:symlink”, “notifier:email_the_boss”)</p>
  </li>
</ul>

<h3 id="transactions">Transactions</h3>
<p>Transaction is used to rollback a failed task.
- Use <code>transaction</code> to run group of tasks. They will run in a transactin.
- The rollback task is defined by <code>on_rollback</code> with in a task.</p>

<pre><code>task :symlink do
  on_rollback do
    run &lt;&lt;-EOC 
      rm #{current_path};
      ln -s #{previous_release} #{current_path}
    EOC
  end
  run "rm #{current_path}; ln -s #{release_path} #{current_path}"
end
</code></pre>

<h3 id="execution">Execution</h3>
<p>Use <code>cap</code> from the command line to execute the capistrano tasks you defined.
- tasks in the arguments are invoked in order.</p>

<h2 id="main-configuration">Main Configuration</h2>
<p>Check out [Configuration Variable][]</p>

<h3 id="server-management">Server Management</h3>
<p><code>role</code> is used to associate a server with a particular role.</p>

<ul>
  <li>The server string could contain <code>user@</code> or <code>:port</code>, this has the highest priority.</li>
  <li>Additional attributes could be specified as a Hash. It is used by tasks to filter server to run commands on.</li>
  <li>When pass a block, the evaluation will be delayed to the first time a command run.</li>
</ul>

<p><code>server</code> is used to assign multiple roles to one host.</p>

<h2 id="main-action-api">Main Action API</h2>
<p><code>run</code> is mostly used to execute arbitrary shell commands on all matched servers.</p>

<pre><code>You could embed `#{sudo}` to run command as sudoer.
</code></pre>

<p><code>capture</code> is used to return the <strong>stdout</strong> to the command as a string.</p>

<p><code>stream</code> is used to stream the stdout locally.</p>

<p><code>download</code>, <code>upload</code> and <code>put</code> to transfer files between remotes and local machine.</p>

<p>Use <code>$CAPISTRANO:HOST$</code> variable to distinguish different servers.</p>

<h2 id="references">References</h2>
<p>[capistrano handbook][]</p>

<p><a href="https://github.com/leehambley/capistrano-handbook/blob/master/index.markdown">capistrano handbook</a>
<a href="https://github.com/capistrano/capistrano/wiki/2.x-Significant-Configuration-Variables">Configuration Variable</a>
<a href="https://github.com/capistrano/capistrano/wiki/2.x-DSL-Documentation-Configuration-Module">DSL Configuration</a>
<a href="https://github.com/capistrano/capistrano/wiki/2.x-DSL-Documentation-Action-Module">DSL Action</a></p>

<h2 id="customized-tasks">Customized Tasks</h2>
<p>All installation is management by <code>apt-get</code>.</p>

<p><code>check:revision</code>: compare the HEAD in the local and remove repository, make sure the remote code base is up-to-date.</p>

<p><code>dev_lib:install</code>: install C libraries on which application depends.</p>

<p><code>nginx:install</code>: install the lastest release of nginx.</p>

<p><code>nginx:setup</code>: generate nginx conf for the application using unicorn as web server.</p>

<p><code>nginx:start/stop/restart/reload</code>: commands mapped to <code>sudo service nginx start/stop/restart/reload</code>.</p>

<p><code>nodejs:install</code>: install node and npm from offcial recommended source.</p>

<p><code>rbenv:install</code>: install rbenv, ruby, patches and libraries which ruby depends on.</p>

<p><code>pg:install</code>: install postgresql.</p>

<p><code>pg:create_db</code>: create database from prompt.</p>

<p><code>pg:setup</code>: generate the database.yml and copied to the shared path.</p>

<p><code>pg:symlink</code>: generate symlink in the current path for the database.yml file.</p>

  </div>
</article>
<nav id="related">
  <div class="related_left">
    <h3>Recent Posts</h3>
    <ul class="posts small">
      
      <li><span>04 May 2013</span> &raquo; <a href="/2013/05/guidelines-for-learning-anything-from-scratch/">Guidelines for Learning Anything from Scratch</a></li>
      
      <li><span>03 May 2013</span> &raquo; <a href="/2013/05/plan-to-read-the-ruby-standard-library/">A Plan to Read the Ruby Standard Library</a></li>
      
      <li><span>24 Mar 2013</span> &raquo; <a href="/2013/03/how-i-finished-the-dbclass-from-stanford-with-full-score/">How I Finished the DBClass from Stanford with Full Score</a></li>
      
    </ul>
  </div>
</nav>
<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'yangchenyunblog'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>


    </div>
    <br class="clear">
    <footer>
      <p>Powered by <a title="Don't worry, it's not the morally ambivalent doctor." href="http://github.com/mojombo/jekyll">Jekyll</a>.<span class="copyright">copyright 2011-2012&copy; <a href="//github.com/yangchenyun">Steven Yang</a></span></p>
      <!-- <p>Also find me on <a href="http://stackoverflow.com/users/966437/steven-yang">stackoverflow</a> and <a href="http://delicious.com/chenyunyang">delicious</a>.</p> -->
    </footer>
  </div>
</body>

<!-- Add this script -->
<script type="text/javascript" src="http://s7.addthis.com/js/300/addthis_widget.js#pubid=ra-4f01c8a46f097959"></script>
<!-- Google Analytics Improved Version -->
<script>var _gaq=[['_setAccount','UA-27986795-1'],['_trackPageview']];(function(d,t){var g=d.createElement(t),s=d.getElementsByTagName(t)[0];g.src='//www.google-analytics.com/ga.js';s.parentNode.insertBefore(g,s)}(document,'script'))
</script>
  <!-- Prompt IE 6 users to install Chrome Frame. Remove this if you want to support IE 6.
       chromium.org/developers/how-tos/chrome-frame-getting-started -->
  <!--[if lt IE 7 ]>
    <script defer src="//ajax.googleapis.com/ajax/libs/chrome-frame/1.0.3/CFInstall.min.js"></script>
    <script defer>window.attachEvent('onload',function(){CFInstall.check({mode:'overlay'})})</script>
  <![endif]-->
</html>
