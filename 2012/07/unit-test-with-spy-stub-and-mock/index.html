<!DOCTYPE html>
<html xmlns:fb="http://www.facebook.com/2008/fbml" xmlns:g="urn:g">
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8" />
  <meta name="keywords" content="杨晨昀, 网站设计, 网站开发, Steven Yang, Chenyun, web designer, shanghai, beijing, china, test, spy, stub, mock">
  <meta name="description" content="Steven Yang's Blog. I mainly write about personal development and frontend development. Use spy, stub and mock in tests">
  <title>Use spy, stub and mock in tests | 杨晨昀 Steven Yang</title>
  <link rel="stylesheet" href="/stylesheets/screen.css">
  <!--[if lt IE 9]>
    <script src="/javascripts/html5.js"></script>
  <![endif]-->
</head>

<body>
  <div class="wrap">
    <div id="sidebar" class="side group clear">
      <header>
        <a href="/">Steven Yang</a>
      </header>
      <nav>
        <ul>
          <li><a href="/about/">About</a></li>
          <li><a href="/contact/">Contact</a></li>
        </ul>

<!-- AddThis Button BEGIN -->
<div class="addthis_toolbox addthis_default_style ">
  <div>
    <a class="addthis_button_facebook_like" fb:like:width="46px"></a>
    <a class='addthis_button_google_plusone' g:plusone:size='small' g:plusone:annotation='none'></a>
    <br class="clear">
  </div>
  <div>
    <a class="addthis_button_douban"></a>
    <a class="addthis_button_sinaweibo"></a>
    <a class="addthis_button_twitter"></a>
    <br class="clear">
  </div>
</div>
<!-- AddThis Button END -->


    </div>
    <div class="content">
      <article class="post">
  <header id="post-title">
    <h1>Use spy, stub and mock in tests</h1>
  </header>
  <div id="post-stats">
    <p>Posted on July 29, 2012</p>
  </div>
  <div id="post-content">
    <p>This article will share some lessons I learned through writing tests at work. It will explain why doing unit-test and shed light on the confusing concepts of <strong>spy</strong>, <strong>stub</strong> and <strong>mock</strong> and how to apply them in order to meet the goal in a unit-test.</p>

<p>The concept itself is explained in general and examples will be written in <code>coffeescript</code> with <code>SinonJS</code>.</p>

<h2 id="what-unit-test">What unit test?</h2>
<p>Spy, stub and mock are all created to accomplish the goal of unit test - <em>“to isolate each part of the program and show that the individual parts are correct.”</em><sup id="fnref:1"><a href="#fn:1" rel="footnote">1</a></sup></p>

<p>Isolation distinguishes unit tests from other test methdology. </p>

<p>For example, in integration testing, one could prepare a collection of HTTP requests with different scenarios and assert the expected HTML/JSON in the HTTP responses. The test takes the application as whole and tests about overall output with certain input. This method closely mimic the end user behavior but it has several disadvantages.</p>

<p>First, when the application grows more complicated, it is costly to cover all the usage scenarios. Because every components in an application contains several alternative paths, when chaining these paths together, the alternatives will be muptipled. </p>

<p>Second, the complexity of the application make it is hard to zero in on exceptions.</p>

<p>For example, you have this calculator under test, it takes more than two arguments and the calculator will invoke one of another four algebra functions according to the first arguments. </p>

<div><script src="https://gist.github.com/3199164.js?file="></script>
<noscript><pre><code>calculator = (method, numbers...) -&gt;
  switch method
    when 'multiple' then multiple(numbers)
    when 'addition' then add(numbers)
    when 'minus' then minus(numbers)
    when 'divide' then divide(numbers)
    else
      throw new Error &quot;method doesn't exist&quot;
multiple = (numbers) -&gt;
  if numbers.length &lt;= 1
    throw new Error 'multiple takes more than one operands'
  else
    numbers.reduce (prev, curr) -&gt;
      prev * curr

addition = (numbers) -&gt;
  if numbers.length &lt;= 1
    throw new Error 'addition takes more than one operands'
  else
    numbers.reduce (prev, curr) -&gt;
      prev + curr

minus = (numbers) -&gt;
  if numbers.length isnt 2
    throw new Error 'minus takes only two operands'
  else
    numbers[0] - numbers[1]

divide = (numbers) -&gt;
  if numbers.length isnt 2
    throw new Error 'divide takes only two operands'
  else
    numbers[0] / numbers[1]</code></pre></noscript></div>

<p>For the first arguments, you have five variations (‘muptiple’, ‘addition’, ‘minus’, ‘divide’ and others), for the second arguments you have three variations(&lt;=1, 2, &gt;2), and in total you get 15 test cases if you use the integration testing approach.</p>

<p>Moreover, there are five possible exceptions might be thrown out of the system.</p>

<p>In contrast, if we take the unit test approach, there are 5 test cases for the <code>calculator</code>, 2 test cases for each individual algebra functions, in total we will have 13 to cover our application. Moreover, each test will throw their own exception which will be easier to detect bugs in the application code.</p>

<p>Unit test helps to reduce the numbers of test cases and detect buggy parts of application. This benefit will be more significant if the application has a more complex architecture and has more input variations. </p>

<p>However, we need to <strong>isolate the behavior</strong> of individual module to adapt unit test in our code. When we invoke <code>calculator()</code> we only care about its behavior, we don’t want to invoke other functions as well. How could we archieve that? </p>

<p>There is where those spy, stub and mock come into play.</p>

<h2 id="what-are-thosespys">What are those…spys?</h2>
<p>spy, stub and mock are all <strong>test doubles</strong>, they are <strong>objects have the same or parts of the original object’ APIs and doesn’t necessary behave the same</strong>. </p>

<h3 id="spy-slient-spy">Spy, Slient Spy</h3>
<p>Test spy is silent, they don’t disturb the running of the application. They just stand in the corner and record everything about the object they are ordered to spy on. They are so careful that they could remember whether the object is invoked or not, how many arguments are passed in and what arguments they are.</p>

<p>Here we use a spy to test the calculator when some invalid methods name are passed in. Notice we don’t interrupt with the execution of the code but assert the behaviors of the <code>calculator</code> function at last.</p>

<div><script src="https://gist.github.com/3199577.js?file="></script>
<noscript><pre><code>describe &quot;calculator&quot;, -&gt;
  it &quot;should throw an error if no method is matched&quot;, -&gt;
    calculatorSpy = sinon.spy sample, 'calculator'
    try
      sample.calculator('non-exist-method', 1, 2)
    catch e
      sinon.assert.threw(calculatorSpy)
</code></pre></noscript></div>

<p>We could do the same for ‘multiple’ method:</p>

<div><script src="https://gist.github.com/3199633.js?file="></script>
<noscript><pre><code>  it &quot;should call the given method when parameter is valid&quot;, -&gt;
    multipleSpy = sinon.spy sample, 'multiple'
    sample.calculator('multiple', 1, 2)
    sinon.assert.calledOnce(multipleSpy)
    sinon.assert.calledWithExactly(multipleSpy, [1, 2])
</code></pre></noscript></div>

<p>This time with the careful work of the spy, we could not only assert the invocation of the <code>multiple</code> method, but also assert the times it is called and the parameters it is passed in.</p>

<p>With a little refactoring, we could test all the five possible paths for the <code>calculator()</code> method based the above two pieces of testings. </p>

<div><script src="https://gist.github.com/3199697.js?file="></script>
<noscript><pre><code>sample = require('../sample')
assert = require('assert')
sinon = require('sinon')

describe &quot;calculator&quot;, -&gt;
  before -&gt;
    @calculator = sinon.spy sample, 'calculator'
    @multiple = sinon.spy sample, 'multiple'
    @addition = sinon.spy sample, 'addition'
    @minus = sinon.spy sample, 'minus'
    @divide = sinon.spy sample, 'divide'

  it &quot;should throw an error if no method is matched&quot;, -&gt;
    try
      sample.calculator('non-exist-method', 1, 2)
    catch e
      sinon.assert.threw(@calculator)

  it &quot;should call the given method when parameter is valid&quot;, -&gt;
    methods = ['multiple', 'addition', 'minus', 'divide']
    for method in methods
      sample.calculator(method, 1, 2)
      sinon.assert.calledOnce(@[method])
      sinon.assert.calledWithExactly(@[method], [1, 2])</code></pre></noscript></div>

<p>We use mocha’s <code>before</code> helper to create spies for all our methods and we share this spies through <code>@</code>(<code>this</code>) across every tests. </p>

<p>The spy is so dictated to its work that we could assert individual method behaviors. But it comes with a caveat, look the following test:</p>

<div><script src="https://gist.github.com/3199904.js?file="></script>
<noscript><pre><code>  it &quot;should call the given method when parameter is valid&quot;, -&gt;
    sample.calculator('minus', 1)
    sinon.assert.calledOnce(@[method])
</code></pre></noscript></div>

<p>the following test fail with an exception <code>Error: minus takes only two operands</code>. This exception is thrown by the <code>minus()</code> method. But we are testing <code>calculator()</code> now, as long as it calls the <code>minus()</code> method correctly, we shouldn’t blame it for exception thrown by other functions. </p>

<p>Thus we need to <strong>isolate <code>calculator()</code> from <code>minus()</code></strong>, that’s what stub and mock is good at.</p>

<h3 id="stubs-they-are-dummy-objects">Stubs, they are dummy objects.</h3>
<p><strong>Stubs are objects with pre-programmed behavior.</strong> Unlike spy, it not only observes the methods but also <strong>alter the output of the method</strong>. In order to isolate the <code>minus()</code> method from the <code>calculator()</code> method, we need to shutdown the <code>minus()</code> method temporarily. </p>

<div><script src="https://gist.github.com/3200012.js?file="></script>
<noscript><pre><code>describe &quot;calculator&quot;, -&gt;
  it &quot;should call the given method when parameter is valid&quot;, -&gt;

    # stub the method instead of just 'spying' it
    minusStub = sinon.stub sample, 'minus'

    methods = ['multiple', 'addition', 'minus', 'divide']
    sample.calculator('minus', 1)
    sinon.assert.calledOnce(minusStub)
    sinon.assert.calledWithExactly(minusStub, [1])

    # restore the minus method
    minusStub.restore()</code></pre></noscript></div>

<p>This tests pass because the actual <code>minus()</code> method is “stubbed” now, and <code>calculator</code> behaves exactly as we expect - call the right method, pass the parameters in an array.</p>

<p>One thing to note for the last line, we need to <strong>restore</strong> this method to its original behavior after test.</p>

<h3 id="mocks">Mocks</h3>
<p>Sometimes, we want more than stubs, we <strong>expect</strong> stubs also have certain behaviors. Add preprogrammed behavior expectation to stubs, we have mocks. Mocks are be viewed as an combination of stubs and assertions. Mocks observe the method behavior as a spy, re-program method behavior as a stub and verify method behavior when it gets called.</p>

<p>Here is our test rewritten with mocks:</p>

<div><script src="https://gist.github.com/3200122.js?file="></script>
<noscript><pre><code>describe &quot;calculator&quot;, -&gt;
  it &quot;should call the given method when parameter is valid&quot;, -&gt;

    # create mocks to verify behaviors
    mock = sinon.mock(sample)
    mock.expects('minus').once().withArgs([1]).returns({})

    methods = ['multiple', 'addition', 'minus', 'divide']
    sample.calculator('minus', 1)

    # verify the behaviors at last
    mock.verify()

    # restore the minus method
    mock.restore()
</code></pre></noscript></div>

<p>With mocks, we also change the structure of our test cases, we move up our assertion to the top of each test cases.</p>

<p>[Some Summary]</p>

<h2 id="further-readings">Further Readings</h2>
<ul>
  <li><a href="http://xunitpatterns.com/Mocks,%20Fakes,%20Stubs%20and%20Dummies.html">xUnit Patterns</a> has a table summaries the difference between spies, stubs and mocks. </li>
  <li>CJ has written a very detailed <a href="http://www.amazon.com/Test-Driven-JavaScript-Development-Developers-Library/dp/0321683919/ref=sr_1_1?ie=UTF8&amp;qid=1343580825&amp;sr=8-1&amp;keywords=test+driven+javascript">book</a> with step-by-step examples about testing in <code>javascript</code>.</li>
  <li>The <a href="http://cjohansen.no/en/javascript/javascript_test_spies_stubs_and_mocks">Sinon.JS</a> Doc he creates is also documented very well.</li>
</ul>

<div class="footnotes">
  <ol>
    <li id="fn:1">
      <p>http://en.wikipedia.org/wiki/Unit_tests<a href="#fnref:1" rel="reference">&#8617;</a></p>
    </li>
  </ol>
</div>

  </div>
</article>
<nav id="related">
  <div class="related_left">
    <h3>Recent Posts</h3>
    <ul class="posts small">
      
      <li><span>17 Feb 2012</span> &raquo; <a href="/2012/02/measure-network-performance/">How to Measure and Monitor Network Performance</a></li>
      
      <li><span>16 Feb 2012</span> &raquo; <a href="/2012/02/plans-for-2012/">Annual Plan 2012 - One Step Further</a></li>
      
      <li><span>31 Dec 2011</span> &raquo; <a href="/2011/12/annual-review/">Annual Review 2011 - A Turning in Life</a></li>
      
    </ul>
  </div>
</nav>
<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'yangchenyunblog'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>


    </div>
    <br class="clear">
    <footer>
      <p>Powered by <a title="Don't worry, it's not the morally ambivalent doctor." href="http://github.com/mojombo/jekyll">Jekyll</a>.<span class="copyright">copyright 2011-2012&copy;Steven Yang</span></p>
      <!-- <p>Also find me on <a href="http://stackoverflow.com/users/966437/steven-yang">stackoverflow</a> and <a href="http://delicious.com/chenyunyang">delicious</a>.</p> -->
    </footer>
  </div>
</body>

<!-- Add this script -->
<script type="text/javascript" src="http://s7.addthis.com/js/300/addthis_widget.js#pubid=ra-4f01c8a46f097959"></script>
<!-- Google Analytics Improved Version -->
<script>var _gaq=[['_setAccount','UA-27986795-1'],['_trackPageview']];(function(d,t){var g=d.createElement(t),s=d.getElementsByTagName(t)[0];g.src='//www.google-analytics.com/ga.js';s.parentNode.insertBefore(g,s)}(document,'script'))
</script>
  <!-- Prompt IE 6 users to install Chrome Frame. Remove this if you want to support IE 6.
       chromium.org/developers/how-tos/chrome-frame-getting-started -->
  <!--[if lt IE 7 ]>
    <script defer src="//ajax.googleapis.com/ajax/libs/chrome-frame/1.0.3/CFInstall.min.js"></script>
    <script defer>window.attachEvent('onload',function(){CFInstall.check({mode:'overlay'})})</script>
  <![endif]-->
</html>
